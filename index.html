<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Database</title>
    <script src="https://accounts.google.com/gsi/client" async defer onload="initGoogleSignIn()"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Roboto', sans-serif; background-color: #f4f4f4; }
        body { display: flex; justify-content: center; align-items: flex-start; padding-top: 5%; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        button { background-color: #1a73e8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .login-container { text-align: center; border: 1px solid #dadce0; border-radius: 8px; padding: 40px; width: 360px; background-color: #fff; }
        .login-container h1 { font-size: 24px; font-weight: 400; color: #202124; margin-top: 0; }
        #login-error { color: #d93025; margin-top: 15px; font-size: 14px; min-height: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; text-align: left; }
        input[type="text"], input[type="password"] { width: 100%; padding: 13px 15px; border: 1px solid #ccc; box-sizing: border-box; border-radius: 4px; }
        .divider { display: flex; align-items: center; text-align: center; margin: 20px 0; font-size: 12px; color: #5f6368; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #dadce0; }
        .divider:not(:empty)::before { margin-right: .5em; }
        .divider:not(:empty)::after { margin-left: .5em; }
        #google-login-button { display: flex; justify-content: center; width: 100%; }
        #app-view label { display: block; font-weight: 500; margin-bottom: 5px; color: #3c4043; }
        .nav-buttons { margin-bottom: 20px; display: flex; align-items: center; }
        .nav-buttons button { margin-right: 10px; background-color: #f1f3f4; color: #202124; }
        #logout-button { background-color: #d93025; color: white; margin-left: auto; }
        #songsList { list-style: none; padding: 0; }
        #songsList li { background-color: #f8f9fa; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; position: relative; }
        #requestsList { list-style: none; padding: 0; }
        #requestsList li { background-color: #fff3cd; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid #f9ab00; }
        .request-actions { margin-top: 10px; }
        .request-actions button { margin-right: 10px; }
        .song-actions button { font-size: 12px; padding: 5px 10px; margin-left: 5px; }
        .play-song-button { background-color: #34a853; }
        .delete-song-button { background-color: #d93025; }
        .request-delete-button { background-color: #f9ab00; }
        .three-dots { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px 10px; color: #5f6368; position: relative; }
        .song-menu { display: none; position: absolute; right: 40px; top: 40px; background: white; border: 1px solid #dadce0; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; min-width: 120px; }
        .song-menu.show { display: block; }
        .song-menu button { display: block; width: 100%; text-align: left; padding: 10px 15px; border: none; background: white; cursor: pointer; font-size: 14px; color: #202124; }
        .song-menu button:hover { background-color: #f1f3f4; }
        #main-audio-player { width: 100%; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="login-view" class="login-container">
        <h1>Sign in</h1>
        <p>to Performance Database</p>
        <div id="google-login-button" style="min-height: 40px; border: 1px solid #dadce0; border-radius: 4px; display: flex; align-items: center; justify-content: center;">Loading Google Sign-In...</div>
        <p id="login-error"></p>
    </div>

    <div id="app-view" class="container hidden">
        <h1>Performance Database</h1>
        <div id="audio-player-container"><p id="now-playing">No song selected.</p><audio id="main-audio-player" controls></audio></div>
        <hr>
        <div class="nav-buttons">
            <button id="view-songs-button">View Songs</button>
            <button id="add-song-button">Add New Song</button>
            <button id="shuffle-button">Shuffle</button>
            <button id="pending-requests-button" class="hidden">Pending Requests</button>
            <button id="logout-button">Logout</button>
        </div>
        <div id="song-list-view"><h2>Your Songs</h2><button id="play-all-button" style="margin-bottom: 15px;">Play All</button><ul id="songsList"></ul></div>
        <div id="pending-requests-view" class="hidden">
            <h2>Pending Delete Requests</h2>
            <ul id="requestsList"></ul>
        </div>
        <div id="add-song-view" class="hidden">
            <h2>Add New Song</h2>
            <div class="form-group"><input type="text" id="songTitle" required placeholder="Enter song title"></div>
            <div class="form-group"><input type="text" id="songArtist" required placeholder="Enter artist name"></div>
            <div class="form-group"><label for="songFile">Upload Audio (MP3, WAV):</label><input type="file" id="songFile" accept=".mp3,.wav,audio/mpeg,audio/wav"></div>
            <p id="upload-status" style="margin-top: 15px;"></p>
            <button id="save-song-button">Save Song</button>
        </div>
    </div>

    <script>
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const songsList = document.getElementById('songsList');
        const audioPlayer = document.getElementById('main-audio-player');
        const nowPlaying = document.getElementById('now-playing');
        const loginError = document.getElementById('login-error');
        let currentObjectUrl = null;
        let currentUserEmail = '';
        let isHost = false;
        const HOST_EMAIL = '25wh1a6683@bvrithyderabad.edu.in';

        const db = {
            _db: null,
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('PerformanceDB', 2);
                    request.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('songs')) e.target.result.createObjectStore('songs', { keyPath: 'id', autoIncrement: true }); };
                    request.onsuccess = e => { this._db = e.target.result; resolve(); };
                    request.onerror = e => { console.error('DB Error:', e.target.errorCode); reject(e.target.errorCode); };
                });
            },
            addSong: function(song) { return new Promise((resolve, reject) => { const t = this._db.transaction(['songs'], 'readwrite'); t.objectStore('songs').add(song); t.oncomplete = () => resolve(); t.onerror = e => reject(e.target.error); }); },
            getSongs: function() { return new Promise((resolve, reject) => { const t = this._db.transaction(['songs'], 'readonly'); const req = t.objectStore('songs').getAll(); t.oncomplete = () => resolve(req.result); t.onerror = e => reject(e.target.error); }); },
            getSong: function(id) { return new Promise((resolve, reject) => { const t = this._db.transaction(['songs'], 'readonly'); const req = t.objectStore('songs').get(id); t.oncomplete = () => resolve(req.result); t.onerror = e => reject(e.target.error); }); },
            deleteSong: function(id) { return new Promise((resolve, reject) => { const t = this._db.transaction(['songs'], 'readwrite'); t.objectStore('songs').delete(id); t.oncomplete = () => resolve(); t.onerror = e => reject(e.target.error); }); },
            updateSong: function(song) { return new Promise((resolve, reject) => { const t = this._db.transaction(['songs'], 'readwrite'); t.objectStore('songs').put(song); t.oncomplete = () => resolve(); t.onerror = e => reject(e.target.error); }); }
        };

        let currentPlaylist = [];
        let currentPlayIndex = 0;

        function decodeJwtResponse(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        async function handleGoogleSignIn(response) {
            const payload = decodeJwtResponse(response.credential);
            if (!payload) { loginError.textContent = "Invalid login token."; return; }
            const requiredDomain = 'bvrithyderabad.edu.in';
            if (payload.hd === requiredDomain || (payload.email && payload.email.endsWith('@' + requiredDomain))) {
                loginError.textContent = '';
                currentUserEmail = payload.email;
                isHost = (currentUserEmail === HOST_EMAIL);
                if (isHost) {
                    document.getElementById('pending-requests-button').classList.remove('hidden');
                }
                await loadSongs();
                showAppView('song-list-view');
            } else {
                loginError.textContent = `Account (${payload.email}) is not allowed. Use a @${requiredDomain} account.`;
                google.accounts.id.disableAutoSelect();
            }
        }

        async function loadSongs() { 
            const songs = await db.getSongs();
            songs.sort((a, b) => (a.order || 0) - (b.order || 0));
            renderSongs(songs); 
        }
        async function shuffleSongs() {
            const songs = await db.getSongs();
            for (let i = songs.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[songs[i], songs[j]] = [songs[j], songs[i]]; }
            renderSongs(songs);
        }
        function renderSongs(songs) {
            songsList.innerHTML = '';
            if (!songs || songs.length === 0) { songsList.innerHTML = '<li>No songs added yet.</li>'; return; }
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                const deleteBtn = isHost ? `<button class="delete-song-button" data-id="${song.id}">Delete</button>` : (song.pendingDelete ? `<span style="color: #d93025; font-size: 12px;">Pending deletion</span>` : `<button class="request-delete-button" data-id="${song.id}">Request Delete</button>`);
                li.innerHTML = `<div><strong>${song.title}</strong><div style="font-size: 14px; color: #5f6368;">${song.artist}</div>${song.fileName ? `<div style="font-size: 12px; color: #80868b;">File: ${song.fileName}</div>` : ''}${song.addedBy ? `<div style="font-size: 11px; color: #80868b;">Added by: ${song.addedBy}</div>` : ''}</div><div class="song-actions">${song.fileData ? `<button class="play-song-button" data-id="${song.id}">Play</button>` : ''}${deleteBtn}<button class="three-dots" data-id="${song.id}" data-index="${index}">â‹®</button><div class="song-menu" id="menu-${song.id}"><button class="move-up" data-id="${song.id}" data-index="${index}">Move Up</button><button class="move-down" data-id="${song.id}" data-index="${index}">Move Down</button></div></div>`;
                songsList.appendChild(li);
            });
        }
        async function playSong(id) {
            if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
            const song = await db.getSong(id);
            if (song && song.fileData) {
                const blob = new Blob([song.fileData], { type: song.fileType });
                currentObjectUrl = URL.createObjectURL(blob);
                audioPlayer.src = currentObjectUrl;
                audioPlayer.play();
                nowPlaying.textContent = `Now Playing: ${song.title} by ${song.artist}`;
            }
        }

        async function playAll() {
            const songs = await db.getSongs();
            currentPlaylist = songs.filter(s => s.fileData);
            if (currentPlaylist.length === 0) { alert('No songs with audio files to play.'); return; }
            currentPlayIndex = 0;
            playSong(currentPlaylist[currentPlayIndex].id);
        }

        audioPlayer.addEventListener('ended', () => {
            if (currentPlaylist.length > 0 && currentPlayIndex < currentPlaylist.length - 1) {
                currentPlayIndex++;
                playSong(currentPlaylist[currentPlayIndex].id);
            }
        });

        async function moveSong(index, direction) {
            const songs = await db.getSongs();
            songs.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= songs.length) return;
            
            [songs[index], songs[newIndex]] = [songs[newIndex], songs[index]];
            
            for (let i = 0; i < songs.length; i++) {
                songs[i].order = i;
                await db.updateSong(songs[i]);
            }
            
            await loadSongs();
        }
        
        function initGoogleSignIn() {
            try {
                google.accounts.id.initialize({
                    client_id: '76671000152-pnf96nato2bg9j8su60tk2n3jacii8nd.apps.googleusercontent.com',
                    callback: handleGoogleSignIn
                });
                google.accounts.id.renderButton(
                    document.getElementById('google-login-button'),
                    { theme: 'outline', size: 'large', width: 360 }
                );
            } catch (e) {
                console.error('Google Sign-In error:', e);
                document.getElementById('google-login-button').innerHTML = '<p style="color: #666; font-size: 12px;">Google Sign-In unavailable</p>';
            }
        }

        function initGoogleSignIn() {
            if (typeof google === 'undefined' || !google.accounts) {
                setTimeout(initGoogleSignIn, 500);
                return;
            }
            try {
                google.accounts.id.initialize({
                    client_id: '76671000152-pnf96nato2bg9j8su60tk2n3jacii8nd.apps.googleusercontent.com',
                    callback: handleGoogleSignIn
                });
                google.accounts.id.renderButton(
                    document.getElementById('google-login-button'),
                    { theme: 'outline', size: 'large', width: 360 }
                );
            } catch (e) {
                console.error('Google Sign-In error:', e);
                document.getElementById('google-login-button').innerHTML = '<p style="color: #666; font-size: 12px;">Google Sign-In unavailable</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => { 
            try { 
                await db.init();
                showLoginView(); 
            } catch (err) { 
                console.error('Initialization error:', err);
                document.body.innerHTML = "<h1>Error: Could not initialize local database.</h1><p>Please make sure you're not in private/incognito mode and IndexedDB is enabled.</p>"; 
            }
        });
        
        songsList.addEventListener('click', async e => { 
            if (!e.target.dataset.id) return; 
            const id = parseInt(e.target.dataset.id, 10); 
            if (e.target.classList.contains('play-song-button')) playSong(id); 
            if (e.target.classList.contains('delete-song-button') && confirm('Are you sure you want to delete this song?')) { 
                await db.deleteSong(id); 
                await loadSongs();
            }
            if (e.target.classList.contains('request-delete-button')) {
                const song = await db.getSong(id);
                song.pendingDelete = true;
                song.deleteRequestedBy = currentUserEmail;
                await db.updateSong(song);
                alert('Delete request sent to host for approval.');
                await loadSongs();
            }
            if (e.target.classList.contains('three-dots')) {
                document.querySelectorAll('.song-menu').forEach(m => m.classList.remove('show'));
                document.getElementById('menu-' + id).classList.toggle('show');
            }
            if (e.target.classList.contains('move-up')) {
                const index = parseInt(e.target.dataset.index, 10);
                await moveSong(index, 'up');
                document.querySelectorAll('.song-menu').forEach(m => m.classList.remove('show'));
            }
            if (e.target.classList.contains('move-down')) {
                const index = parseInt(e.target.dataset.index, 10);
                await moveSong(index, 'down');
                document.querySelectorAll('.song-menu').forEach(m => m.classList.remove('show'));
            }
        });

        async function loadPendingRequests() {
            const songs = await db.getSongs();
            const pending = songs.filter(s => s.pendingDelete);
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';
            if (pending.length === 0) {
                requestsList.innerHTML = '<li>No pending delete requests.</li>';
                return;
            }
            pending.forEach(song => {
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${song.title}</strong> by ${song.artist}</div><div style="font-size: 12px; color: #5f6368; margin-top: 5px;">Requested by: ${song.deleteRequestedBy}</div><div class="request-actions"><button class="approve-delete" data-id="${song.id}" style="background-color: #34a853; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Approve</button><button class="deny-delete" data-id="${song.id}" style="background-color: #5f6368; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Deny</button></div>`;
                requestsList.appendChild(li);
            });
        }

        document.getElementById('requestsList').addEventListener('click', async e => {
            const id = parseInt(e.target.dataset.id, 10);
            if (!id) return;
            if (e.target.classList.contains('approve-delete')) {
                await db.deleteSong(id);
                alert('Song deleted.');
                await loadPendingRequests();
            }
            if (e.target.classList.contains('deny-delete')) {
                const song = await db.getSong(id);
                delete song.pendingDelete;
                delete song.deleteRequestedBy;
                await db.updateSong(song);
                alert('Delete request denied.');
                await loadPendingRequests();
            }
        });
            if (!e.target.classList.contains('three-dots')) {
                document.querySelectorAll('.song-menu').forEach(m => m.classList.remove('show'));
            }
        });

        document.addEventListener('click', (e) => {
        document.getElementById('play-all-button').addEventListener('click', playAll);
        document.getElementById('pending-requests-button').addEventListener('click', () => { loadPendingRequests(); showAppView('pending-requests-view'); });
        document.getElementById('shuffle-button').addEventListener('click', shuffleSongs);
        document.getElementById('view-songs-button').addEventListener('click', () => { loadSongs(); showAppView('song-list-view'); });
        document.getElementById('add-song-button').addEventListener('click', () => { document.getElementById('songTitle').value = ''; document.getElementById('songArtist').value = ''; document.getElementById('songFile').value = ''; document.getElementById('upload-status').textContent = ''; showAppView('add-song-view'); });
        document.getElementById('logout-button').addEventListener('click', () => { if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl); audioPlayer.src = ''; nowPlaying.textContent = 'No song selected.'; google.accounts.id.disableAutoSelect(); showLoginView(); }); 
            const title = document.getElementById('songTitle').value.trim(); 
            const artist = document.getElementById('songArtist').value.trim(); 
            const file = document.getElementById('songFile').files[0]; 
            const status = document.getElementById('upload-status'); 
            if (!title || !artist) { alert('Please enter title and artist.'); return; } 
            status.textContent = 'Saving...'; 
            const songs = await db.getSongs();
            const song = { title, artist, order: songs.length, addedBy: currentUserEmail }; 
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = async (e) => { 
                    song.fileData = e.target.result; 
                    song.fileName = file.name; 
                    song.fileType = file.type; 
                    await db.addSong(song); 
                    await loadSongs(); 
                    showAppView('song-list-view'); 
                }; 
                reader.readAsArrayBuffer(file); 
            } else { 
                await db.addSong(song); 
                await loadSongs(); 
                showAppView('song-list-view'); 
            }
        };

        function showAppView(viewId) { loginView.classList.add('hidden'); appView.classList.remove('hidden'); document.body.style.justifyContent = 'flex-start'; document.body.style.paddingTop = '2%'; document.querySelectorAll('#app-view > div[id$="-view"]').forEach(v => v.classList.add('hidden')); document.getElementById(viewId).classList.remove('hidden'); }
        function showLoginView() { appView.classList.add('hidden'); loginView.classList.remove('hidden'); document.body.style.justifyContent = 'center'; document.body.style.paddingTop = '5%'; }
    </script>
</body>
</html>
